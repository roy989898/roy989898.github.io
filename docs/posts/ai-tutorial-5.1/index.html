<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Ai Tutorial 5.1 Image Classification &gt;2 types 1 :: Terminal</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Image Classification 1 #hide !pip install -Uqq fastbook import fastbook fastbook.setup_book() #hide from fastbook import * ``````py from fastai.vision.all import * path = untar_data(URLs.PETS) #hide Path.BASE_PATH = path See the image path.ls() (path/&amp;#34;images&amp;#34;).ls() Get the file name fname = (path/&amp;#34;images&amp;#34;).ls()[1] # Path(&amp;#39;images/havanese_158.jpg&amp;#39;) fname.name # havanese_158.jpg use regex to get the file name
re.findall(r&amp;#39;(.&#43;)_\d&#43;.jpg$&amp;#39;, fname.name) # [&amp;#39;havanese&amp;#39;] Prepare the data pets = DataBlock(blocks = (ImageBlock, CategoryBlock), get_items=get_image_files, splitter=RandomSplitter(seed=42), get_y=using_attr(RegexLabeller(r&amp;#39;(.&#43;)_\d&#43;.jpg$&amp;#39;), &amp;#39;name&amp;#39;), item_tfms=Resize(460), batch_tfms=aug_transforms(size=224, min_scale=0." />
<meta name="keywords" content=", " />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://roy989898.github.io/posts/ai-tutorial-5.1/" />




<link rel="stylesheet" href="https://roy989898.github.io/assets/style.css">

  <link rel="stylesheet" href="https://roy989898.github.io/assets/pink.css">






<link rel="apple-touch-icon" href="https://roy989898.github.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://roy989898.github.io/img/favicon/pink.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Ai Tutorial 5.1 Image Classification &gt;2 types 1">
<meta property="og:description" content="Image Classification 1 #hide !pip install -Uqq fastbook import fastbook fastbook.setup_book() #hide from fastbook import * ``````py from fastai.vision.all import * path = untar_data(URLs.PETS) #hide Path.BASE_PATH = path See the image path.ls() (path/&amp;#34;images&amp;#34;).ls() Get the file name fname = (path/&amp;#34;images&amp;#34;).ls()[1] # Path(&amp;#39;images/havanese_158.jpg&amp;#39;) fname.name # havanese_158.jpg use regex to get the file name
re.findall(r&amp;#39;(.&#43;)_\d&#43;.jpg$&amp;#39;, fname.name) # [&amp;#39;havanese&amp;#39;] Prepare the data pets = DataBlock(blocks = (ImageBlock, CategoryBlock), get_items=get_image_files, splitter=RandomSplitter(seed=42), get_y=using_attr(RegexLabeller(r&amp;#39;(.&#43;)_\d&#43;.jpg$&amp;#39;), &amp;#39;name&amp;#39;), item_tfms=Resize(460), batch_tfms=aug_transforms(size=224, min_scale=0." />
<meta property="og:url" content="https://roy989898.github.io/posts/ai-tutorial-5.1/" />
<meta property="og:site_name" content="Terminal" />

  <meta property="og:image" content="https://roy989898.github.io/">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2021-05-06 16:15:02 &#43;0800 CST" />












</head>
<body class="pink">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Pom&#39;s Programmer Blog
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/showcase">Showcase</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/showcase">Showcase</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://roy989898.github.io/posts/ai-tutorial-5.1/">Ai Tutorial 5.1 Image Classification &gt;2 types 1</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-05-06 
      </span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://roy989898.github.io/tags/ai/">ai</a>&nbsp;
    
    #<a href="https://roy989898.github.io/tags/fastai/">fastai</a>&nbsp;
    
    #<a href="https://roy989898.github.io/tags/pytorch/">pytorch</a>&nbsp;
    
    #<a href="https://roy989898.github.io/tags/%E5%AF%AB%E7%B5%A6%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88%E5%B8%AB%E7%9A%84%E6%B7%B1%E5%BA%A6%E5%AD%B8%E7%BF%92%E4%BD%BF%E7%94%A8fastai%E5%92%8Cpytorch/">寫給程式設計師的深度學習：使用fastai和PyTorch</a>&nbsp;
    
    #<a href="https://roy989898.github.io/tags/image-classification/">Image Classification</a>&nbsp;
    
  </span>
  

  

  

  <div class="post-content"><div>
        <h1 id="image-classification-1">Image Classification 1<a href="#image-classification-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#hide</span>
<span style="color:#960050;background-color:#1e0010">!</span>pip install <span style="color:#f92672">-</span>Uqq fastbook
<span style="color:#f92672">import</span> fastbook
fastbook<span style="color:#f92672">.</span>setup_book()

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#hide</span>
<span style="color:#f92672">from</span> fastbook <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

<span style="color:#e6db74">``````</span>py
<span style="color:#f92672">from</span> fastai.vision.all <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
path <span style="color:#f92672">=</span> untar_data(URLs<span style="color:#f92672">.</span>PETS)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#hide</span>
Path<span style="color:#f92672">.</span>BASE_PATH <span style="color:#f92672">=</span> path
</code></pre></div><h2 id="see-the-image">See the image<a href="#see-the-image" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">path<span style="color:#f92672">.</span>ls()

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">(path<span style="color:#f92672">/</span><span style="color:#e6db74">&#34;images&#34;</span>)<span style="color:#f92672">.</span>ls()
</code></pre></div><h2 id="get-the-file-name">Get the file name<a href="#get-the-file-name" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">fname <span style="color:#f92672">=</span> (path<span style="color:#f92672">/</span><span style="color:#e6db74">&#34;images&#34;</span>)<span style="color:#f92672">.</span>ls()[<span style="color:#ae81ff">1</span>]
<span style="color:#75715e"># Path(&#39;images/havanese_158.jpg&#39;)</span>
fname<span style="color:#f92672">.</span>name
<span style="color:#75715e"># havanese_158.jpg</span>
</code></pre></div><p>use regex to get the file name</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(.+)_\d+.jpg$&#39;</span>, fname<span style="color:#f92672">.</span>name)
<span style="color:#75715e"># [&#39;havanese&#39;]</span>
</code></pre></div><h2 id="prepare-the-data">Prepare the data<a href="#prepare-the-data" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">pets <span style="color:#f92672">=</span> DataBlock(blocks <span style="color:#f92672">=</span> (ImageBlock, CategoryBlock),
                 get_items<span style="color:#f92672">=</span>get_image_files, 
                 splitter<span style="color:#f92672">=</span>RandomSplitter(seed<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>),
                 get_y<span style="color:#f92672">=</span>using_attr(RegexLabeller(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(.+)_\d+.jpg$&#39;</span>), <span style="color:#e6db74">&#39;name&#39;</span>),
                 item_tfms<span style="color:#f92672">=</span>Resize(<span style="color:#ae81ff">460</span>),
                 batch_tfms<span style="color:#f92672">=</span>aug_transforms(size<span style="color:#f92672">=</span><span style="color:#ae81ff">224</span>, min_scale<span style="color:#f92672">=</span><span style="color:#ae81ff">0.75</span>))
dls <span style="color:#f92672">=</span> pets<span style="color:#f92672">.</span>dataloaders(path<span style="color:#f92672">/</span><span style="color:#e6db74">&#34;images&#34;</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">
<span style="color:#75715e"># this is presizing</span>
<span style="color:#75715e">#  item_tfms=Resize(460),</span>
<span style="color:#75715e">#                  batch_tfms=aug_transforms(size=224, min_scale=0.75))</span>
</code></pre></div><p>we apply the aug_transforms at gpu to a batch of image,but before that,we need to make the image to the smae size,yhan pass the sendor to the GPU,
so we apply Resize(460) to each item at CPU.<br>
first step:<br>
Crop full width or height: This is in item_tfms, so it&rsquo;s applied to each individual image before it is copied to the GPU. It&rsquo;s used to ensure all images are the same size. On the training set, the crop area is chosen randomly. On the validation set, the center square of the image is always chosen.
we crop them to a bigger(460) square.Why bigger? because we wnat to have  have spare margin to allow further augmentation transforms on their inner regions without creating empty zones.if performed after resizing down to the augmented size, various common data augmentation transforms might introduce spurious empty zones, degrade data, or both .e.g. rotating an image by 45 degrees fills corner regions of the new bounds with emptiness, which will not teach the model anything.This transformation works by resizing to a square, using a large crop size. On the training set, the crop area is chosen randomly, and the size of the crop is selected to cover the entire width or height of the image, whichever is smaller.<br>
second step:<br>
Random crop and augment: This is in batch_tfms,
at second step,GPU is used for all data augmentation,with a single interpolation(make the picture more clear) at the end.
On the training set, the random crop and any other augmentations are done first.<br>
我們將gpu上的aug_transforms應用於一批圖像，但是在此之前，我們需要將圖像調整為smae大小，然後將發送方傳遞到GPU，
因此我們將Resize（460）應用於CPU的每個項目。
第一步：
裁剪全寬或全高：這位於item_tfms中，因此在將其複製到GPU之前將其應用於每個單獨的圖像。用於確保所有圖像的尺寸相同。在訓練集上，隨機選擇作物面積。在驗證集上，始終選擇圖像的中心正方形。
我們將它們裁剪到更大的（460）平方。為什麼更大？因為我們擁有足夠的餘量以允許在其內部區域上進行進一步的增強變換而不會創建空白區域，如果在縮小大小到增大大小之後執行此操作，則各種常見的數據增強變換可能會引入虛假的空白區域，降級數據或同時出現這兩種情況。將圖像旋轉45度會以空的方式填充新邊界的角區域，這將不會對模型產生任何影響。此轉換通過使用大作物大小將尺寸調整為正方形來進行。在訓練集上，隨機選擇作物區域，並選擇作物的大小以覆蓋圖像的整個寬度或高度，以較小者為準。
第二步：
隨機裁剪和擴充：這在batch_tfms中，
第二步，將GPU用於所有數據擴充，最後進行一次插值（使畫面更清晰）。
在訓練集上，首先進行隨機裁剪和任何其他擴充。
<img src="/img/ai_t/t1/att_00060.png" alt="tr"></p>
<h2 id="checking-and-debugging-a-datablock">Checking and Debugging a DataBlock<a href="#checking-and-debugging-a-datablock" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Checking</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e"># show some image</span>
dls<span style="color:#f92672">.</span>show_batch(nrows<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)

</code></pre></div><p><img src="/img/ai_t/t1/check.PNG" alt="check"></p>
<p>we should check all the data,that the tag is correct,we can check by our eyes,or by the <a href="https://roy989898.github.io/posts/ai-tutorial-2/#start-create-the-model" title="model">model</a></p>
<p>Debugging</p>
<p>error because the image size is different</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#75715e">#hide_output</span>
pets1 <span style="color:#f92672">=</span> DataBlock(blocks <span style="color:#f92672">=</span> (ImageBlock, CategoryBlock),
                 get_items<span style="color:#f92672">=</span>get_image_files, 
                 splitter<span style="color:#f92672">=</span>RandomSplitter(seed<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>),
                 get_y<span style="color:#f92672">=</span>using_attr(RegexLabeller(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(.+)_\d+.jpg$&#39;</span>), <span style="color:#e6db74">&#39;name&#39;</span>))
pets1<span style="color:#f92672">.</span>summary(path<span style="color:#f92672">/</span><span style="color:#e6db74">&#34;images&#34;</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">Setting<span style="color:#f92672">-</span>up type transforms pipelines
Collecting items <span style="color:#f92672">from</span> <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>jhoward<span style="color:#f92672">/.</span>fastai<span style="color:#f92672">/</span>data<span style="color:#f92672">/</span>oxford<span style="color:#f92672">-</span>iiit<span style="color:#f92672">-</span>pet<span style="color:#f92672">/</span>images
Found <span style="color:#ae81ff">7390</span> items
<span style="color:#ae81ff">2</span> datasets of sizes <span style="color:#ae81ff">5912</span>,<span style="color:#ae81ff">1478</span>
Setting up Pipeline: PILBase<span style="color:#f92672">.</span>create
Setting up Pipeline: partial <span style="color:#f92672">-&gt;</span> Categorize

Building one sample
  Pipeline: PILBase<span style="color:#f92672">.</span>create
    starting <span style="color:#f92672">from</span>
      <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>jhoward<span style="color:#f92672">/.</span>fastai<span style="color:#f92672">/</span>data<span style="color:#f92672">/</span>oxford<span style="color:#f92672">-</span>iiit<span style="color:#f92672">-</span>pet<span style="color:#f92672">/</span>images<span style="color:#f92672">/</span>american_pit_bull_terrier_31<span style="color:#f92672">.</span>jpg
    applying PILBase<span style="color:#f92672">.</span>create gives
      PILImage mode<span style="color:#f92672">=</span>RGB size<span style="color:#f92672">=</span><span style="color:#ae81ff">500</span>x414
  Pipeline: partial <span style="color:#f92672">-&gt;</span> Categorize
    starting <span style="color:#f92672">from</span>
      <span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>jhoward<span style="color:#f92672">/.</span>fastai<span style="color:#f92672">/</span>data<span style="color:#f92672">/</span>oxford<span style="color:#f92672">-</span>iiit<span style="color:#f92672">-</span>pet<span style="color:#f92672">/</span>images<span style="color:#f92672">/</span>american_pit_bull_terrier_31<span style="color:#f92672">.</span>jpg
    applying partial gives
      american_pit_bull_terrier
    applying Categorize gives
      TensorCategory(<span style="color:#ae81ff">13</span>)

Final sample: (PILImage mode<span style="color:#f92672">=</span>RGB size<span style="color:#f92672">=</span><span style="color:#ae81ff">500</span>x414, TensorCategory(<span style="color:#ae81ff">13</span>))


Setting up after_item: Pipeline: ToTensor
Setting up before_batch: Pipeline: 
Setting up after_batch: Pipeline: IntToFloatTensor

Building one batch
Applying item_tfms to the first sample:
  Pipeline: ToTensor
    starting <span style="color:#f92672">from</span>
      (PILImage mode<span style="color:#f92672">=</span>RGB size<span style="color:#f92672">=</span><span style="color:#ae81ff">500</span>x414, TensorCategory(<span style="color:#ae81ff">13</span>))
    applying ToTensor gives
      (TensorImage of size <span style="color:#ae81ff">3</span>x414x500, TensorCategory(<span style="color:#ae81ff">13</span>))

Adding the next <span style="color:#ae81ff">3</span> samples

No before_batch transform to apply

Collating items <span style="color:#f92672">in</span> a batch
Error<span style="color:#960050;background-color:#1e0010">!</span> It<span style="color:#e6db74">&#39;s not possible to collate your items in a batch</span>
Could <span style="color:#f92672">not</span> collate the <span style="color:#ae81ff">0</span><span style="color:#f92672">-</span>th members of your tuples because got the following shapes
torch<span style="color:#f92672">.</span>Size([<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">414</span>, <span style="color:#ae81ff">500</span>]),torch<span style="color:#f92672">.</span>Size([<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">375</span>, <span style="color:#ae81ff">500</span>]),torch<span style="color:#f92672">.</span>Size([<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">500</span>, <span style="color:#ae81ff">281</span>]),torch<span style="color:#f92672">.</span>Size([<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">203</span>, <span style="color:#ae81ff">300</span>])
<span style="color:#f92672">---------------------------------------------------------------------------</span>
<span style="color:#a6e22e">RuntimeError</span>                              Traceback (most recent call last)
<span style="color:#f92672">&lt;</span>ipython<span style="color:#f92672">-</span>input<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>c0a3d421ca2<span style="color:#f92672">&gt;</span> <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>
      <span style="color:#ae81ff">4</span>                  splitter<span style="color:#f92672">=</span>RandomSplitter(seed<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>),
      <span style="color:#ae81ff">5</span>                  get_y<span style="color:#f92672">=</span>using_attr(RegexLabeller(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(.+)_\d+.jpg$&#39;</span>), <span style="color:#e6db74">&#39;name&#39;</span>))
<span style="color:#f92672">----&gt;</span> <span style="color:#ae81ff">6</span> pets1<span style="color:#f92672">.</span>summary(path<span style="color:#f92672">/</span><span style="color:#e6db74">&#34;images&#34;</span>)

<span style="color:#f92672">~/</span>git<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>data<span style="color:#f92672">/</span>block<span style="color:#f92672">.</span>py <span style="color:#f92672">in</span> summary(self, source, bs, show_batch, <span style="color:#f92672">**</span>kwargs)
    <span style="color:#ae81ff">182</span>         why <span style="color:#f92672">=</span> _find_fail_collate(s)
    <span style="color:#ae81ff">183</span>         <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Make sure all parts of your samples are tensors of the same size&#34;</span> <span style="color:#66d9ef">if</span> why <span style="color:#f92672">is</span> None <span style="color:#66d9ef">else</span> why)
<span style="color:#f92672">--&gt;</span> <span style="color:#ae81ff">184</span>         <span style="color:#66d9ef">raise</span> e
    <span style="color:#ae81ff">185</span> 
    <span style="color:#ae81ff">186</span>     <span style="color:#66d9ef">if</span> len([f <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> dls<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>after_batch<span style="color:#f92672">.</span>fs <span style="color:#66d9ef">if</span> f<span style="color:#f92672">.</span>name <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;noop&#39;</span>])<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>:

<span style="color:#f92672">~/</span>git<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>data<span style="color:#f92672">/</span>block<span style="color:#f92672">.</span>py <span style="color:#f92672">in</span> summary(self, source, bs, show_batch, <span style="color:#f92672">**</span>kwargs)
    <span style="color:#ae81ff">176</span>     <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Collating items in a batch&#34;</span>)
    <span style="color:#ae81ff">177</span>     <span style="color:#66d9ef">try</span>:
<span style="color:#f92672">--&gt;</span> <span style="color:#ae81ff">178</span>         b <span style="color:#f92672">=</span> dls<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>create_batch(s)
    <span style="color:#ae81ff">179</span>         b <span style="color:#f92672">=</span> retain_types(b, s[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">if</span> is_listy(s) <span style="color:#66d9ef">else</span> s)
    <span style="color:#ae81ff">180</span>     <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:

<span style="color:#f92672">~/</span>git<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>data<span style="color:#f92672">/</span>load<span style="color:#f92672">.</span>py <span style="color:#f92672">in</span> create_batch(self, b)
    <span style="color:#ae81ff">125</span>     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">retain</span>(self, res, b):  <span style="color:#66d9ef">return</span> retain_types(res, b[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">if</span> is_listy(b) <span style="color:#66d9ef">else</span> b)
    <span style="color:#ae81ff">126</span>     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_item</span>(self, s):  <span style="color:#66d9ef">return</span> next(self<span style="color:#f92672">.</span>it) <span style="color:#66d9ef">if</span> s <span style="color:#f92672">is</span> None <span style="color:#66d9ef">else</span> self<span style="color:#f92672">.</span>dataset[s]
<span style="color:#f92672">--&gt;</span> <span style="color:#ae81ff">127</span>     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_batch</span>(self, b): <span style="color:#66d9ef">return</span> (fa_collate,fa_convert)[self<span style="color:#f92672">.</span>prebatched](b)
    <span style="color:#ae81ff">128</span>     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_batch</span>(self, b): <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>retain(self<span style="color:#f92672">.</span>create_batch(self<span style="color:#f92672">.</span>before_batch(b)), b)
    <span style="color:#ae81ff">129</span>     <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to</span>(self, device): self<span style="color:#f92672">.</span>device <span style="color:#f92672">=</span> device

<span style="color:#f92672">~/</span>git<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>data<span style="color:#f92672">/</span>load<span style="color:#f92672">.</span>py <span style="color:#f92672">in</span> fa_collate(t)
     <span style="color:#ae81ff">44</span>     b <span style="color:#f92672">=</span> t[<span style="color:#ae81ff">0</span>]
     <span style="color:#ae81ff">45</span>     <span style="color:#66d9ef">return</span> (default_collate(t) <span style="color:#66d9ef">if</span> isinstance(b, _collate_types)
<span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">46</span>             <span style="color:#66d9ef">else</span> type(t[<span style="color:#ae81ff">0</span>])([fa_collate(s) <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> zip(<span style="color:#f92672">*</span>t)]) <span style="color:#66d9ef">if</span> isinstance(b, Sequence)
     <span style="color:#ae81ff">47</span>             <span style="color:#66d9ef">else</span> default_collate(t))
     <span style="color:#ae81ff">48</span> 

<span style="color:#f92672">~/</span>git<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>data<span style="color:#f92672">/</span>load<span style="color:#f92672">.</span>py <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>listcomp<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>)
     <span style="color:#ae81ff">44</span>     b <span style="color:#f92672">=</span> t[<span style="color:#ae81ff">0</span>]
     <span style="color:#ae81ff">45</span>     <span style="color:#66d9ef">return</span> (default_collate(t) <span style="color:#66d9ef">if</span> isinstance(b, _collate_types)
<span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">46</span>             <span style="color:#66d9ef">else</span> type(t[<span style="color:#ae81ff">0</span>])([fa_collate(s) <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> zip(<span style="color:#f92672">*</span>t)]) <span style="color:#66d9ef">if</span> isinstance(b, Sequence)
     <span style="color:#ae81ff">47</span>             <span style="color:#66d9ef">else</span> default_collate(t))
     <span style="color:#ae81ff">48</span> 

<span style="color:#f92672">~/</span>git<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>fastai<span style="color:#f92672">/</span>data<span style="color:#f92672">/</span>load<span style="color:#f92672">.</span>py <span style="color:#f92672">in</span> fa_collate(t)
     <span style="color:#ae81ff">43</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fa_collate</span>(t):
     <span style="color:#ae81ff">44</span>     b <span style="color:#f92672">=</span> t[<span style="color:#ae81ff">0</span>]
<span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">45</span>     <span style="color:#66d9ef">return</span> (default_collate(t) <span style="color:#66d9ef">if</span> isinstance(b, _collate_types)
     <span style="color:#ae81ff">46</span>             <span style="color:#66d9ef">else</span> type(t[<span style="color:#ae81ff">0</span>])([fa_collate(s) <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> zip(<span style="color:#f92672">*</span>t)]) <span style="color:#66d9ef">if</span> isinstance(b, Sequence)
     <span style="color:#ae81ff">47</span>             <span style="color:#66d9ef">else</span> default_collate(t))

<span style="color:#f92672">~/</span>anaconda3<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python3<span style="color:#f92672">.</span><span style="color:#ae81ff">7</span><span style="color:#f92672">/</span>site<span style="color:#f92672">-</span>packages<span style="color:#f92672">/</span>torch<span style="color:#f92672">/</span>utils<span style="color:#f92672">/</span>data<span style="color:#f92672">/</span>_utils<span style="color:#f92672">/</span>collate<span style="color:#f92672">.</span>py <span style="color:#f92672">in</span> default_collate(batch)
     <span style="color:#ae81ff">53</span>             storage <span style="color:#f92672">=</span> elem<span style="color:#f92672">.</span>storage()<span style="color:#f92672">.</span>_new_shared(numel)
     <span style="color:#ae81ff">54</span>             out <span style="color:#f92672">=</span> elem<span style="color:#f92672">.</span>new(storage)
<span style="color:#f92672">---&gt;</span> <span style="color:#ae81ff">55</span>         <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>stack(batch, <span style="color:#ae81ff">0</span>, out<span style="color:#f92672">=</span>out)
     <span style="color:#ae81ff">56</span>     <span style="color:#66d9ef">elif</span> elem_type<span style="color:#f92672">.</span>__module__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;numpy&#39;</span> <span style="color:#f92672">and</span> elem_type<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;str_&#39;</span> \
     <span style="color:#ae81ff">57</span>             <span style="color:#f92672">and</span> elem_type<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;string_&#39;</span>:

<span style="color:#a6e22e">RuntimeError</span>: invalid argument <span style="color:#ae81ff">0</span>: Sizes of tensors must match <span style="color:#66d9ef">except</span> <span style="color:#f92672">in</span> dimension <span style="color:#ae81ff">0.</span> Got <span style="color:#ae81ff">414</span> <span style="color:#f92672">and</span> <span style="color:#ae81ff">375</span> <span style="color:#f92672">in</span> dimension <span style="color:#ae81ff">2</span> at <span style="color:#f92672">/</span>opt<span style="color:#f92672">/</span>conda<span style="color:#f92672">/</span>conda<span style="color:#f92672">-</span>bld<span style="color:#f92672">/</span>pytorch_1579022060824<span style="color:#f92672">/</span>work<span style="color:#f92672">/</span>aten<span style="color:#f92672">/</span>src<span style="color:#f92672">/</span>TH<span style="color:#f92672">/</span>generic<span style="color:#f92672">/</span>THTensor<span style="color:#f92672">.</span>cpp:<span style="color:#ae81ff">612</span>
</code></pre></div><p>now we can train it</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py">learn <span style="color:#f92672">=</span> cnn_learner(dls, resnet34, metrics<span style="color:#f92672">=</span>error_rate)
learn<span style="color:#f92672">.</span>fine_tune(<span style="color:#ae81ff">2</span>)
</code></pre></div>
      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://roy989898.github.io/posts/ai-tutorial-5.2/">
                <span class="button__icon">←</span>
                <span class="button__text">Ai Tutorial 5.2 Image Classification &gt;2 types Cross-entropy loss 1</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://roy989898.github.io/posts/ai-tutorial-4.12/">
                <span class="button__text">Ai Tutorial 4.12 Adding a Nonlinearity</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2021 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://roy989898.github.io/assets/main.js"></script>
<script src="https://roy989898.github.io/assets/prism.js"></script>







  
</div>

</body>
</html>
